#!/bin/bash

# exit if another instance is running
if pidof -o %PPID -x backlight-ctl > /dev/null; then
    echo "Another instance is already running. Exiting..."
    exit
fi

STORAGE=/var/lib/backlight-ctl

if [ $1 = "mon" ]; then
    DEVICE=/sys/class/backlight/intel_backlight
    min=30
    step=5
elif [ $1 = "kbd" ]; then
    DEVICE=/sys/class/leds/asus::kbd_backlight
    min=0
    step=1
else
    echo "Unknown device " $1
    exit 1
fi

curr=$(cat $DEVICE/brightness)
max=$(cat $DEVICE/max_brightness)

if [ $2 = '+' ]; then
	next=$((curr+step))
elif [ $2 = '-' ]; then
	next=$((curr-step))
elif [ $2 = "save" ]; then
    mkdir -p $STORAGE
    echo $curr > $STORAGE/$1
elif [ $2 = "restore" ] && [ -f $STORAGE/$1 ]; then
    next=$(cat $STORAGE/$1)
else # $2 is a number
    next=$2
fi

if [ $next ]; then
    if [ $next -lt $min ]; then
        next=$min
    elif [ $next -gt $max ]; then
        next=$max
    fi
    sign=$(($curr < $next ? 1 : -1))
    for i in $(seq $curr $sign $next); do
        echo $i > $DEVICE/brightness
        sleep 0.01
    done
fi
