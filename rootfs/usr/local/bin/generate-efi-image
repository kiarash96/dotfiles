#!/bin/sh

# Config options
CMDLINE="root=/dev/disk/by-uuid/d690a698-ecdf-4292-86a6-9c9dd8686292 rw loglevel=3 quiet bgrt_disable"
LINUX="/boot/vmlinuz-linux"
UCODE="/boot/intel-ucode.img"
INITRD="/boot/booster-linux.img"
SPLASH="/usr/share/systemd/bootctl/splash-arch.bmp"
OUTPUT="/boot/efi/linuxx64.efi"

cmdline=$(mktemp)
echo "$CMDLINE" > "$cmdline"

initrd=$(mktemp)
cat "$UCODE" "$INITRD" > "$initrd"

objcopy \
    --add-section .osrel="/etc/os-release" --change-section-vma .osrel=0x20000 \
    --add-section .cmdline="$cmdline" --change-section-vma .cmdline=0x30000 \
    --add-section .splash="$SPLASH" --change-section-vma .splash=0x40000 \
    --add-section .linux="$LINUX" --change-section-vma .linux=0x2000000 \
    --add-section .initrd="$initrd" --change-section-vma .initrd=0x3000000 \
    "/usr/lib/systemd/boot/efi/linuxx64.efi.stub" "$OUTPUT"

